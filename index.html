<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Racerdroid : A tool to detect concurrency bugs in Android applications">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Racerdroid</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/midori1/RacerDroid">View on GitHub</a>

          <h1 id="project_title">Racerdroid</h1>
          <h2 id="project_tagline">A tool to detect concurrency bugs in Android applications</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/midori1/RacerDroid/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/midori1/RacerDroid/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="racerdroid" class="anchor" href="#racerdroid" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>RacerDroid</h1>

<h3>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Introduction</h3>

<p>This is a site to display the test result of RacerDroid. We perform RacerDroid on several open source applications to evaluate the feasibility of the technique. The numerical result is shown in the table.</p>

<table>
<thead>
<tr>
<th>Subject</th>
<th>Components</th>
<th># of potential data races</th>
<th>TP</th>
<th>FP</th>
<th>TP (manual)</th>
<th>FP (manual)</th>
</tr>
</thead>
<tbody>
<tr>
<td>ToDoWidget</td>
<td>ColorCircle</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>ConnectBot</td>
<td>HostEditorActivity</td>
<td>5</td>
<td>2</td>
<td>3</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>ConnectBot</td>
<td>HostListActivity</td>
<td>4</td>
<td>2</td>
<td>2</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>ConnectBot</td>
<td>PubkeyListActivity</td>
<td>4</td>
<td>0</td>
<td>4</td>
<td>0</td>
<td>4</td>
</tr>
<tr>
<td>ConnectBot</td>
<td>TerminalManager</td>
<td>2</td>
<td>2</td>
<td>0</td>
<td>2</td>
<td>0</td>
</tr>
<tr>
<td>AnyMemo</td>
<td>DownloaderAnyMemo</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>MyTrack</td>
<td>MyTracks / TrackRecordingService</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>OI File Manager</td>
<td>FileListManager</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>The following sections describe the details of each case.</p>

<p><strong>The code of the test case can be downloaded from the link at the top of the page or <a href="https://github.com/midori1/RacerDroid">https://github.com/midori1/RacerDroid</a>.</strong></p>

<p><strong>As the test case generation tool is still developing, in order to confirm the potential data races, we generate the test cases by manually trigger the callbacks and record the events using the recorder we developed.</strong></p>

<h3>
<a id="mytracks" class="anchor" href="#mytracks" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MyTracks</h3>

<p><a href="https://play.google.com/store/apps/details?id=com.zihua.android.mytracks">MyTrack</a> is an app to record your track.
The detail of the test of this app is presented on the paper. The example in the following figure shows the segment codes that are related to this race. </p>

<p><img src="https://static.oschina.net/uploads/img/201605/12220903_owKA.png" alt="a code snippet of Mytracks releated to the data race" title="a code snippet of Mytracks releated to the data race"></p>

<p>Fig.1 a code snippet of Mytracks releated to the data race</p>

<p>In the activity MyTracks, when the user presses the button to start a track recording, <code>startRecording()</code> callback will be invoked, which starts and binds <code>TrackRecordingService</code> service. As soon as the service is ready, an event would be sent to the <code>Looper</code> of UI thread and callback <code>onServiceConnected()</code> will be executed when this event is dispatched, which calls <code>startNewTrack()</code> in <code>TrackRecordingService</code> through IPC mechanism. When user stops recording, <code>stopRecording()</code> callback will be invoked which stops and unbinds <code>TrackRecordingService</code>. This procedure would invoke <code>onDestroy()</code> asynchronously that set the <code>providerUtils</code> to null. In the ‘normal’ execution, <code>onDestroy()</code> will be invoked after <code>startNewTrack()</code>. However, there exists a situation that is contrary to the ‘normal’ execution. Due to <code>TrackRecordingService</code> is started and stopped asynchronously, <code>startNewTrack()</code> may still not be executed while <code>onDestroy()</code> has been performed, and an exception is thrown when <code>startNewTrack()</code> is invoked.</p>

<p>As our test case generation tool is still developing, in order to confirm this potential data race, we first generate a test case manually that will trigger these two callbacks. Fig.2 shows the corresponding test case. This test case first press menu button to show the options menu on the screen and start a recording by press the record button. Then we call the options menu again and press the button to stop the record. At last, we save the record. When this test case is executed without controlling schedule, <code>onServiceConnected()</code> will be invoked before <code>onDestroy()</code> with high probability. Therefore, no exception will be thrown. During the test case replay, when <code>onServiceConnected()</code> is monitored to be scheduled, RacerDroid will suspend its dispatch by removing it from the queue. After <code>onDestroy()</code> callback of service <code>TrackRecordingService</code>  is scheduled, RacerDroid will then resume the execution of <code>onServiceConnected()</code> task. In this way, this concurrency bug is guaranteed to be produced.</p>

<p><img src="https://static.oschina.net/uploads/img/201605/12223734_xkcA.png" alt="Test case of MyTrack" title="Test case of MyTrack"></p>

<p>Fig.2 Test case of MyTrack</p>

<h3>
<a id="anymemo" class="anchor" href="#anymemo" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>AnyMemo</h3>

<p><a href="http://anymemo.org/">AnyMemo</a> is a free open-sourced spaced repetition flashcard learning software similar to SuperMemo for Android mobile phones. We use test it on version 10.2 whose code can be downloaded in <a href="https://github.com/helloworld1/AnyMemo">https://github.com/helloworld1/AnyMemo</a>. This data race is reported in [].</p>

<p>The following figure shows the segment codes that are related to this race. When <code>DownloaderAnyMemo</code>(the activity used to download the data bases) is shown to the user, <code>onCreate()</code> will invoke <code>initialRetrieve()</code> which create a background thread that downloads data. During the downloading, the user is notified about the progress using a <code>ProgressDialog</code> component. After the downloading task is finish, a message include a <code>Runnable</code> object will be posted to the message queue indicates the downloading is finish and the data will be displayed to the user. </p>

<p><img src="https://static.oschina.net/uploads/img/201605/04145607_bXVh.png" alt="a code snippet of AnyMemo releated to the data race" title="A code segment of AnyMemo"></p>

<p>Fig.3 a code snippet of AnyMemo releated to the data race</p>

<p>The result of analyzer shows that the run method and the <code>onDestroy()</code> callback of the activity have races as when the background is finish after <code>onDestroy()</code> is executed. From the code we know that this bug is result from the execution of <code>mDialog.dismiss()</code> and the system will throw an exception: “java.lang.IllegalArgumentException: View not attached to window manager” because this method is trying to remove the ProgressDialog view which is no longer attached to the window manager.</p>

<p>As our test case generation tool is still developing, in order to confirm this potential data race, we first generate a test case manually that will trigger these two callbacks. The figure below shows the corresponding test case. This test case first turns to the download activity (<code>DownloaderAnyMemo</code>) and starts the download background thread immediately , waits until the download is end and rotate the screen (this will call <code>onDestroy()</code>) and at last check if it runs as expected. In the base schedule, the run method in the finish message will run before <code>onDestory()</code>.</p>

<p><img src="https://static.oschina.net/uploads/img/201605/04151445_XE9U.png" alt="the test case of AnyMemo" title="the test case of AnyMemo"></p>

<p>Fig.4 the test case of AnyMemo</p>

<p>As <code>onDestroy()</code> and <code>run()</code> are both invoked by the framework asynchronously, RacerDroid will replay the generated test case by reordering the two events with the sequence that <code>onDestory()</code> runs before <code>onPostExecute()</code>. In this schedule, the exception will be thrown, making the app crash.</p>

<h3>
<a id="oi-file-manager" class="anchor" href="#oi-file-manager" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>OI File Manager</h3>

<p><a href="https://github.com/openintents/filemanager">OI File Manager</a> for Android is an open file manager that seamlessly cooperates with other applications. We use version 2.0.7 to perform our test.</p>

<p>The bug of this app is almost same as the one in AnyMemo, they are both corresponding to the <code>ProgressDialog</code>. Therefore, we just present the test case of the app instead of describing the detail of this bug. </p>

<h3>
<a id="connectbot" class="anchor" href="#connectbot" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>ConnectBot</h3>

<p><a href="https://github.com/connectbot/connectbot">ConnectBot</a> is an SSH client for android. We test this application based on a patch of the source code committed by <a href="http://mir.cs.illinois.edu/%7Eyulin2/asynchronizer/">Asynchronizer</a>.</p>

<p>The table shows potential data races in 4 components of ConnectBot. We use the one in the <code>HostListActivity</code> as an example. This data race is reported by the same work as the code is committed. The code snippet related to the bug is shown in the following figure.</p>

<p><img src="https://static.oschina.net/uploads/img/201605/04170121_dBJP.png" alt="the code segment related to the data race" title="the code segment related to the data race"></p>

<p>Fig.5 the code segment related to the data race</p>

<p>One can acknowledge that there is a potential data race between the <code>doInBackground</code> function which call <code>saveHost</code> on <code>hostdb</code> and the <code>onStop</code> function which set <code>hostdb</code> to null. Apparently, if the <code>onStop</code> call is before the <code>FindSaveHostTask</code>’s execution on <code>hostdb</code>, the data race is triggered and a <code>NullPointerException</code> would be thrown. This scenario can be produced when the <code>doInBackground</code> costs so many time that <code>onStop</code> is finish before “<code>hostdb.saveHost</code> is called. </p>

<p>However, if we replay the trace directly, the execution of <code>hostdb.saveHost</code> and <code>onStop</code> function couldn’t be ensured to be in the same order at each replaying because the scheduling of the <code>FindSaveHostTask</code> (starts when the instruction <code>mDevice.pressKeyCode(KeyEvent.KEYCODE_ENTER);</code> is called) is not predictable. To guarantee the data race can always be triggered, we should exchange the execution order of the two functions.</p>

<p>Through our instrumentation, we have inserted the semaphore at the <code>doInBackground</code> function. To exchange the order, we need to delay the <code>AsyncTask</code> until <code>onStop</code> is executed. The test case is shown in this figure.</p>

<p><img src="https://static.oschina.net/uploads/img/201605/04171217_Ogtm.png" alt="the test case of connectbot" title="the test case of connectbot"></p>

<p>Fig.6 the test case of connectbot</p>

<h3>
<a id="todowidget" class="anchor" href="#todowidget" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>ToDoWidget</h3>

<p>ToDoList is an memo application that you can add widget contains a todo-list in the screen. We test the version of 1.7.1 using a data race reported in work[]. </p>

<p>This bug is a false warning one that is not a real data race because the pair of events are always handled in the same thread and one is invoked by another one so that their execution are in a fixed order that we can’t reschedule them.</p>

<p>The example in figure 7 shows a simplified version of the data race found by static analysis in <code>ToDoWidget</code> application. The class <code>ColorCircle</code> extends the <code>View</code> class to display a color selector used to select the font color. When the user touch the circle, the <code>onTouchEvent</code> function is called to handle the user action and it will invoke the <code>invalidate</code> method. Here is the description of this method in the API manual : “If the view is visible, onDraw(android.graphics.Canvas) will be called at some point in the future. This must be called from a UI thread. “</p>

<p><img src="https://static.oschina.net/uploads/img/201605/13110713_eCv6.png" alt="todowidget code snippet2" title="the code related to the potential bug">
<img src="https://static.oschina.net/uploads/img/201605/13110606_EbQC.png" alt="todowidget code snippet1" title="the code related to the potential bug"></p>

<p>Fig 7. the simplified code related to the potential bug</p>

<p>The static analyzer deem the execution of two callbacks <code>onDraw</code> and <code>onTouchEvent</code> can have potential data races on variable <code>mTrackingCenter</code>. It seems validate given the simplified pseudo code because the <code>onTouchEvent</code> changes the value of <code>mTrackingCenter</code> according to the position of the touch event while <code>onDraw</code> reads this variable and performs some operations based on <code>mTrackingCenter</code>. When <code>onTouchEvent</code> is executed after or concurrently with the execution of <code>onDraw</code>, the “read-write” data race is possibly triggered.</p>

<p>After the exploring, a test case covers this two callbacks is generated. Then run this test case and schedule the execution of the callbacks to produce the data races. In this example, the scheduler should delay the execution of <code>onTouchEvent</code> until <code>onDraw</code> is called. We capture the messages that call this two callbacks when they are dispatched from the <code>queueInterrogator</code> and delay the message that calls  <code>onTouchEvent</code> to achieve this. However, when we catch the target message and delay it, we couldn’t find the message of <code>onDraw</code> in the queue no matter how mach time we wait. Under this situation, we could never produce this data race and the data race is considered to be false positive.</p>

<p>To explain why this data race is false positive, the description of the method <code>invalidate</code> mentioned is the answer because the this method will call <code>onDraw</code> at some point in the future in the UI thread which is the same of the thread <code>onTouch</code>. This ensures that the <code>onDraw</code> method is strictly executed after <code>onTouchEvent</code> and will never trigger the data race. </p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Racerdroid maintained by <a href="https://github.com/midori1">midori1</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
